<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Joystick Bluetooth Reader</title>
  <style>
    body {
      background: #111;
      color: #0f0;
      font-family: monospace, monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    #status {
      margin-bottom: 10px;
      font-weight: bold;
      font-size: 1.2rem;
    }
    #data {
      font-size: 1.1rem;
      white-space: pre-wrap;
      border: 1px solid #0f0;
      padding: 10px;
      border-radius: 8px;
      width: 300px;
      text-align: center;
      user-select: none;
    }
    button {
      background: #0f0;
      color: #000;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 20px;
      transition: background 0.3s;
    }
    button:hover {
      background: #0c0;
    }
  </style>
</head>
<body>
  <div id="status">Disconnected</div>
  <div id="data">No data yet.</div>
  <button id="connectBtn">Connect Bluetooth Joystick</button>

<script>
  const connectBtn = document.getElementById('connectBtn');
  const statusDiv = document.getElementById('status');
  const dataDiv = document.getElementById('data');

  let port;
  let reader;
  let keepReading = false;

  function updateStatus(text, color = '#0f0') {
    statusDiv.textContent = text;
    statusDiv.style.color = color;
  }

  function updateJoystick(x, y, button) {
    dataDiv.textContent = `X: ${x}\nY: ${y}\nButton: ${button === 0 ? 'Pressed' : 'Released'}`;
  }

  async function readLoop() {
    keepReading = true;
    const decoder = new TextDecoderStream();
    const inputDone = port.readable.pipeTo(decoder.writable);
    const inputStream = decoder.readable;

    reader = inputStream.getReader();

    let buffer = '';

    while (keepReading) {
      try {
        const { value, done } = await reader.read();
        if (done) {
          break;
        }
        if (value) {
          buffer += value;
          // Split by newline to get full lines
          let lines = buffer.split('\n');
          // Keep last partial line in buffer
          buffer = lines.pop();

          lines.forEach(line => {
            const cleaned = line.trim();
            // Match format: X:<num>, Y:<num>, Button:<num>
            const match = cleaned.match(/X:(\d+),\s*Y:(\d+),\s*Button:(\d+)/);
            if (match) {
              const xVal = parseInt(match[1], 10);
              const yVal = parseInt(match[2], 10);
              const buttonVal = parseInt(match[3], 10);
              updateJoystick(xVal, yVal, buttonVal);
            }
          });
        }
      } catch (error) {
        console.error('Read error:', error);
        break;
      }
    }
    updateStatus('Disconnected', '#f00');
  }

  async function connect() {
    try {
      port = await navigator.serial.requestPort();
      await port.open({ baudRate: 9600 });
      updateStatus('Connected');
      connectBtn.disabled = true;
      readLoop();
    } catch (err) {
      updateStatus('Connection failed', '#f00');
      console.error(err);
    }
  }

  connectBtn.addEventListener('click', connect);
</script>
</body>
</html>
